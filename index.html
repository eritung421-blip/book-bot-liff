<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eri's Reading Hub ğŸ“–</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #455A64; --secondary: #78909C; --accent: #81C784; --bg: #F5F7F8; --white: #FFFFFF; --text: #37474F; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 480px; background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); box-sizing: border-box; }
        h2 { color: var(--primary); font-size: 1.2rem; text-align: center; margin-top: 0; font-weight: 600; }
        .nav-tabs { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 20px; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .nav-tabs button { flex: 0 0 auto; padding: 10px 15px; font-size: 0.85rem; border: none; border-radius: 10px; background-color: #ECEFF1; color: var(--secondary); cursor: pointer; }
        .nav-tabs button.active { background-color: var(--primary); color: white; font-weight: 600; }
        label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: var(--secondary); font-weight: 500; }
        .flex-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ECEFF1; border-radius: 10px; font-size: 0.95rem; box-sizing: border-box; background-color: #FAFAFA; color: var(--text); }
        select { appearance: none; padding-right: 40px !important; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2378909C'%3E%3Cpath d='M2 4l4 4 4-4H2z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: calc(100% - 15px) center; }
        .main-btn { width: 100%; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1rem; cursor: pointer; margin-top: 10px; font-weight: 500; }
        .chart-container { height: 230px; margin-bottom: 25px; position: relative; border: 1px solid #F0F0F0; border-radius: 15px; padding: 10px; }
        #stats-loader { display: none; text-align: center; padding: 60px 0; }
        #cardPreview { width: 100%; border-radius: 15px; border: 1px solid #eee; margin-top: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .search-box { margin-bottom: 10px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%2378909C'%3E%3Cpath d='M11.7 10.3l-2.4-2.4c.4-.6.7-1.3.7-2.1 0-1.9-1.6-3.5-3.5-3.5S3 3.9 3 5.8s1.6 3.5 3.5 3.5c.8 0 1.5-.3 2.1-.7l2.4 2.4 1.4-1.4zM4.5 5.8c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 12px center; padding-left: 38px; }
        #loading-text { display: none; text-align: center; color: var(--secondary); font-size: 0.8rem; margin-top: 10px; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        .tag-container { 
            display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; 
            padding: 12px; background: #FAFAFA; border-radius: 12px; border: 1px solid #ECEFF1;
        }
        .tag-chip { 
            display: flex; align-items: center; background-color: #ECEFF1; 
            color: var(--text); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; 
        }
        .tag-delete { 
            margin-left: 8px; cursor: pointer; color: #EF5350; font-weight: bold; font-size: 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h2>Eri's Reading Hub ğŸ“–</h2>

    <div class="nav-tabs">
        <button id="tab-add" class="active" onclick="switchTab('add')">æ–°å¢æ›¸ç±</button>
        <button id="tab-update" onclick="switchTab('update')">è£œè¨˜å¿ƒå¾—</button>
        <button id="tab-stats" onclick="switchTab('stats')">é–±è®€çµ±è¨ˆ</button>
        <button id="tab-share" onclick="switchTab('share')">åˆ†äº«å¡ç‰‡</button>
        <button id="tab-manage" onclick="switchTab('manage')">åˆ†é¡ç®¡ç†</button>
    </div>

    <div id="page-add">
        <div id="book-list-container">
            <div class="book-card">
                <label>æ›¸å (ä¸­æ–‡ / åŸæ–‡)</label>
                <div class="flex-row">
                    <input type="text" class="field-title" placeholder="ä¸­æ–‡æ›¸å">
                    <input type="text" class="field-origin-title" placeholder="åŸæ–‡/Link">
                </div>
                <label>ä½œè€… (è­¯è€… / åŸæ–‡ä½œè€…)</label>
                <div class="flex-row">
                    <input type="text" class="field-author" placeholder="è­¯è€…/ä¸»ç·¨">
                    <input type="text" class="field-origin-author" placeholder="åŸæ–‡ä½œè€…">
                </div>
                <div class="flex-row">
                    <div style="flex:1;"><label>åˆ†é¡</label><select class="field-category" id="add-category-select"></select></div>
                    <div style="flex:1;"><label>è©•åˆ†</label><select class="field-rating">
                        <option value="å°šæœªè©•åˆ†">å°šæœªè©•åˆ†</option>
                        <option value="â­â­â­â­â­">5æ˜Ÿ</option><option value="â­â­â­â­">4æ˜Ÿ</option>
                        <option value="â­â­â­">3æ˜Ÿ</option><option value="â­â­">2æ˜Ÿ</option><option value="â­">1æ˜Ÿ</option>
                    </select></div>
                </div>
                <label>é–±è®€ç‹€æ…‹</label>
                <select class="field-status">
                    <option value="é–±è®€å®Œç•¢â˜‘ï¸">é–±è®€å®Œç•¢â˜‘ï¸</option>
                    <option value="æ­£åœ¨è®€ğŸ“–">æ­£åœ¨è®€ğŸ“–</option>
                    <option value="é¡˜æœ›æ¸…å–®ğŸ§š">é¡˜æœ›æ¸…å–®ğŸ§š</option>
                </select>
                <label style="margin-top:8px;">åˆæ­¥æƒ³æ³•</label>
                <textarea class="field-review" rows="2" placeholder="ç°¡çŸ­çš„å¿ƒå¾—..."></textarea>
            </div>
        </div>
        <button type="button" onclick="submitBulk()" class="main-btn">ç¢ºèªå„²å­˜è‡³ Notion</button>
    </div>

    <div id="page-update" style="display: none;">
        <label>æœå°‹æ›¸ç±</label>
        <input type="text" class="search-box" placeholder="æœå°‹æ›¸åæˆ–ä½œè€…..." oninput="filterBooks(this, 'update-select-book')">
        <select id="update-select-book"></select>
        <label style="margin-top:10px;">è£œå¯«è©³ç´°å¿ƒå¾—</label>
        <textarea id="update-review-text" rows="6" placeholder="å¯«ä¸‹ä½ çš„æ·±åº¦è®€å¾Œæ„Ÿ..."></textarea>
        <button type="button" onclick="submitSingleReview()" class="main-btn" style="background-color: var(--accent);">æ›´æ–°ç´€éŒ„</button>
    </div>

    <div id="page-stats" style="display: none;">
        <div class="form-group"><label>åˆ‡æ›çµ±è¨ˆæœˆä»½</label><input type="month" id="stats-month-picker" onchange="loadStats()"></div>
        <div id="stats-loader"><span class="spinner"></span>æ•¸æ“šè¨ˆç®—ä¸­...</div>
        <div id="stats-content">
            <div style="display: flex; justify-content: space-around; margin-bottom: 20px; text-align: center;">
                <div><p style="font-size: 0.7rem;">æœˆåº¦é–±è®€</p><h2 id="stat-month">0</h2></div>
                <div><p style="font-size: 0.7rem;">å¹´åº¦ç´¯è¨ˆ</p><h2 id="stat-year">0</h2></div>
            </div>
            <label style="text-align:center;">ğŸ“Š é–±è®€è¶¨å‹¢</label>
            <div class="chart-container"><canvas id="trendChart"></canvas></div>
            <label style="text-align:center;">ğŸ¨ åˆ†é¡ä½”æ¯”</label>
            <div class="chart-container"><canvas id="categoryChart"></canvas></div>
        </div>
    </div>

    <div id="page-share" style="display: none;">
        <label>1. æœå°‹ä¸¦é¸å–æ›¸ç±</label>
        <input type="text" class="search-box" placeholder="è¼¸å…¥é—œéµå­—..." oninput="filterBooks(this, 'share-select-book')">
        <select id="share-select-book" onchange="onShareSelectionChange()"></select>
        
        <label style="margin-top:10px;">2. ä¿®æ”¹åˆ†äº«å¿ƒå¾— (è‡ªå‹•å¸¶å…¥ Notion å…§é è³‡æ–™)</label>
        <textarea id="share-text-editor" rows="3" oninput="drawCanvasCard()" placeholder="å¯«ä¸‹æƒ³åˆ†äº«çš„é‡‘å¥..."></textarea>
        
        <div style="text-align:center;">
            <canvas id="shareCanvas" width="1080" height="1920" style="display:none;"></canvas>
            <img id="cardPreview" alt="ç”Ÿæˆçš„å¡ç‰‡">
            <button class="main-btn" onclick="shareToSystem()" style="background: var(--accent);">ğŸ“² åˆ†äº«è‡³ IG é™æ™‚å‹•æ…‹</button>
        </div>
    </div>

    <div id="page-manage" style="display: none;">
        <label>ç¾æœ‰åˆ†é¡ (é»æ“Š Ã— ç§»é™¤)</label>
        <div id="tag-list" class="tag-container"></div>
        <div class="flex-row">
            <input type="text" id="new-tag-input" placeholder="æ–°åˆ†é¡åç¨±">
            <button onclick="addLocalTag()" style="padding:0 15px; background:var(--primary); color:white; border:none; border-radius:10px;">+</button>
        </div>
        <button class="main-btn" onclick="syncToNotion()" style="background:var(--accent);">ğŸš€ åŒæ­¥åˆ†é¡è‡³ Notion</button>
    </div>

    <div id="loading-text"><span class="spinner"></span> è™•ç†ä¸­...</div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzgAb1yf5Ny3i85DMq86CRubqQYe_ml-M7Bckbf6ArJIQs7DAcCw9x76SyHwAfOufVeCw/exec";
    let trendChart, categoryChart, bookList = [], categories = ["è‡ªæˆ‘æˆé•·", "å¿ƒç†å­¸", "æ–‡å­¸å°èªª", "å•†æ¥­ç†è²¡"];

    document.getElementById('stats-month-picker').value = new Date().toISOString().slice(0, 7);

    function switchTab(tab) {
        ['add', 'update', 'stats', 'share', 'manage'].forEach(t => {
            document.getElementById(`page-${t}`).style.display = (t === tab) ? 'block' : 'none';
            document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
        });
        if(tab === 'manage') renderTags();
        if(tab === 'share' || tab === 'update') fetchBooks();
        if(tab === 'stats') loadStats();
        if(tab === 'add') populateCategorySelect();
    }

    function filterBooks(input, selectId) {
        const filter = input.value.toLowerCase();
        const select = document.getElementById(selectId);
        select.innerHTML = bookList
            .filter(b => b.title.toLowerCase().includes(filter) || b.author.toLowerCase().includes(filter))
            .map(b => `<option value="${b.id}">${b.title}</option>`).join('');
        if(selectId === 'share-select-book') onShareSelectionChange();
    }

    // ğŸ”¥ å‡ç´šç‰ˆï¼šæ·±åº¦æŠ“å–å¿ƒå¾—å¾Œå†ç•«åœ–
    async function onShareSelectionChange() {
        const id = document.getElementById('share-select-book').value;
        const loader = document.getElementById('loading-text');
        if(!id) return;
        
        loader.style.display = 'block';
        try {
            const res = await fetch(`${GAS_URL}?action=get_book_detail&pageId=${id}`);
            const result = await res.json();
            if (result.success) {
                const book = result.data;
                // æ›´æ–°å…¨åŸŸæ›¸å–®ä¸­å°æ‡‰çš„ review èˆ‡ aiSummary è³‡æ–™
                const idx = bookList.findIndex(b => b.id === id);
                if(idx !== -1) bookList[idx] = book;

                // çµ„åˆå¿ƒå¾—å¸¶å…¥ç·¨è¼¯æ¡†
                const combinedText = book.review || "é€™æ˜¯ä¸€æœ¬å€¼å¾—æ·±åº¦æ€è€ƒçš„å¥½æ›¸ã€‚";
                document.getElementById('share-text-editor').value = combinedText;
                drawCanvasCard();
            }
        } catch (e) { console.error("æŠ“å–ç´°ç¯€å¤±æ•—", e); }
        finally { loader.style.display = 'none'; }
    }

    // ğŸ¨ ç•«å¸ƒé‚è¼¯ï¼šæ–°å¢æœˆä»½èˆ‡æ˜Ÿç´š
    function drawCanvasCard() {
        const canvas = document.getElementById('shareCanvas');
        const ctx = canvas.getContext('2d');
        const id = document.getElementById('share-select-book').value;
        const book = bookList.find(b => b.id === id);
        const userReview = document.getElementById('share-text-editor').value;

        // èƒŒæ™¯èˆ‡ç¸®å°æ¨™é¡Œ
        ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, 1080, 1920);
        ctx.fillStyle = "#455A64"; ctx.fillRect(0, 0, 1080, 420);

        ctx.fillStyle = "#FFFFFF"; 
        ctx.font = "bold 45px sans-serif";
        ctx.fillText("ERI'S READING LOG", 100, 180);
        
        // ğŸ”¥ å³ä¸Šè§’ç¹ªè£½ï¼šé–±è®€æœˆä»½
        ctx.font = "40px sans-serif";
        ctx.textAlign = "right";
        ctx.fillText(book?.date || "", 980, 180);
        ctx.textAlign = "left";

        // ä¸»æ›¸åèˆ‡åŸæ–‡æ›¸å
        ctx.fillStyle = "#37474F"; ctx.font = "bold 95px sans-serif";
        ctx.fillText(book?.title || "Book Title", 100, 600);
        
        ctx.fillStyle = "#90A4AE"; ctx.font = "45px sans-serif";
        ctx.fillText(book?.originTitle || "", 100, 690);

        // ä½œè€…èˆ‡æ˜Ÿç´š
        ctx.fillStyle = "#78909C"; ctx.font = "50px sans-serif";
        ctx.fillText("by " + (book?.author || "Unknown"), 100, 800);
        
        // ğŸ”¥ ç¹ªè£½é‡‘è‰²æ˜Ÿç´š
        ctx.fillStyle = "#FFB300"; 
        ctx.font = "55px sans-serif";
        ctx.fillText(book?.rating || "", 100, 890);

        // å¿ƒå¾—å€å¡Š
        ctx.fillStyle = "#F5F7F8"; ctx.fillRect(100, 1000, 880, 600);
        ctx.fillStyle = "#455A64"; ctx.font = "italic 42px sans-serif";
        wrapCanvasText(ctx, userReview, 140, 1130, 800, 65);

        document.getElementById('cardPreview').src = canvas.toDataURL("image/png");
    }

    function wrapCanvasText(ctx, text, x, y, maxWidth, lineHeight) {
        let chars = text.split(''); let line = '';
        for(let n = 0; n < chars.length; n++) {
            let testLine = line + chars[n];
            if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                ctx.fillText(line, x, y); line = chars[n]; y += lineHeight;
            } else { line = testLine; }
        }
        ctx.fillText(line, x, y);
    }

    async function loadStats() {
        const month = document.getElementById('stats-month-picker').value;
        const loader = document.getElementById('stats-loader');
        const content = document.getElementById('stats-content');
        loader.style.display = 'block'; content.style.display = 'none';
        try {
            const res = await fetch(`${GAS_URL}?action=get_stats_raw&month=${month}`);
            const json = await res.json();
            const d = json.data;
            document.getElementById('stat-month').innerText = d.summary.thisMonth;
            document.getElementById('stat-year').innerText = d.summary.thisYear;
            const tCtx = document.getElementById('trendChart').getContext('2d');
            if(trendChart) trendChart.destroy();
            trendChart = new Chart(tCtx, {
                type: 'bar',
                data: { labels: Object.keys(d.trend), datasets: [{ data: Object.values(d.trend), backgroundColor: '#78909C', borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            const cCtx = document.getElementById('categoryChart').getContext('2d');
            if(categoryChart) categoryChart.destroy();
            categoryChart = new Chart(cCtx, {
                type: 'doughnut',
                data: { labels: Object.keys(d.categoryDist), datasets: [{ data: Object.values(d.categoryDist), backgroundColor: ['#81C784', '#4DD0E1', '#FFD54F', '#BA68C8'] }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });
            content.style.display = 'block';
        } catch(e) { console.error("Stats Error", e); }
        finally { loader.style.display = 'none'; }
    }

    async function fetchBooks() {
        const res = await fetch(GAS_URL + "?action=get_book_list");
        const json = await res.json();
        bookList = json.data;
        const options = bookList.map(b => `<option value="${b.id}">${b.title}</option>`).join('');
        document.getElementById('update-select-book').innerHTML = options;
        document.getElementById('share-select-book').innerHTML = options;
        if(bookList.length > 0) onShareSelectionChange();
    }

    async function submitBulk() {
        const data = [];
        document.querySelectorAll('.book-card').forEach(c => {
            const t = c.querySelector('.field-title').value;
            if(t) data.push({
                title: t, originTitle: c.querySelector('.field-origin-title').value,
                author: c.querySelector('.field-author').value, originAuthor: c.querySelector('.field-origin-author').value,
                category: c.querySelector('.field-category').value, rating: c.querySelector('.field-rating').value,
                status: c.querySelector('.field-status').value, review: c.querySelector('.field-review').value,
                dateStr: new Date().toISOString().slice(0, 7)
            });
        });
        document.getElementById('loading-text').style.display = 'block';
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'liff_submit_bulk', data }) });
        const result = await res.json();
        alert(result.success ? 'âœ… å„²å­˜æˆåŠŸï¼' : 'âŒ å„²å­˜å¤±æ•—');
        location.reload();
    }

    async function syncToNotion() {
        document.getElementById('loading-text').style.display = 'block';
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'sync_categories', data: categories }) });
        const json = await res.json();
        alert(json.success ? 'âœ… åˆ†é¡åŒæ­¥æˆåŠŸï¼' : 'âŒ åŒæ­¥å¤±æ•—');
        document.getElementById('loading-text').style.display = 'none';
    }

    async function shareToSystem() {
        const canvas = document.getElementById('shareCanvas');
        canvas.toBlob(async blob => {
            const file = new File([blob], "reading-note.png", { type: "image/png" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) await navigator.share({ files: [file] });
            else alert("ä¸æ”¯æ´åˆ†äº«ï¼Œè«‹é•·æŒ‰åœ–ç‰‡å„²å­˜");
        });
    }

    function renderTags() {
        const list = document.getElementById('tag-list');
        if (!list) return;
            list.innerHTML = categories.map((c, i) => `
            <div class="tag-chip">
                ${c} 
                <span class="tag-delete" onclick="categories.splice(${i},1);renderTags()">Ã—</span>
            </div>
        `).join('');
    }    
    function addLocalTag() { const v = document.getElementById('new-tag-input').value; if(v){ categories.push(v); document.getElementById('new-tag-input').value=''; renderTags(); } }
    function populateCategorySelect() { document.getElementById('add-category-select').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join(''); }

    async function submitSingleReview() {
        const payload = { action: 'update_review', data: { pageId: document.getElementById('update-select-book').value, rating: "â­â­â­â­â­", review: document.getElementById('update-review-text').value } };
        document.getElementById('loading-text').style.display = 'block';
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
        const result = await res.json();
        alert(result.success ? 'âœ… æ›´æ–°æˆåŠŸï¼' : 'âŒ å¤±æ•—');
        location.reload();
    }

    liff.init({ liffId: "2008731100-q3JK2BPf" });
</script>
</body>
</html>
