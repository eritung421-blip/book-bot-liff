<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eri's Reading Hub ğŸ“–</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { 
            --primary: #455A64; --secondary: #78909C; --accent: #81C784; 
            --bg: #F5F7F8; --white: #FFFFFF; --text: #37474F; 
        }
        body { 
            font-family: -apple-system, "Noto Sans TC", sans-serif; 
            background-color: var(--bg); color: var(--text); 
            margin: 0; padding: 20px; display: flex; justify-content: center; 
        }
        .container { 
            width: 100%; max-width: 450px; background: var(--white); 
            padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            box-sizing: border-box; 
        }
        h2 { color: var(--primary); font-size: 1.3rem; text-align: center; margin-top: 0; font-weight: 600; letter-spacing: 1px; }
        
        /* å°è¦½åˆ—èˆ‡æ²å‹•å„ªåŒ– */
        .nav-tabs { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 20px; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .nav-tabs button { 
            flex: 0 0 auto; padding: 10px 15px; font-size: 0.85rem; border: none; border-radius: 10px; 
            background-color: #ECEFF1; color: var(--secondary); cursor: pointer; font-weight: 400;
        }
        .nav-tabs button.active { background-color: var(--primary); color: white; font-weight: 600; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 400; margin-bottom: 6px; color: var(--secondary); }
        .flex-row { display: flex; gap: 8px; }
        .flex-row input { flex: 1; width: 50%; }

        /* ä¸‹æ‹‰é¸å–® UI ä¿®æ­£ï¼šå¢åŠ å…§è·é˜²æ­¢åœ–ç¤ºå¤ªæ“  */
        select { 
            appearance: none; width: 100%; padding: 12px; padding-right: 40px !important; 
            border: 1px solid #ECEFF1; border-radius: 10px; font-size: 0.95rem; 
            box-sizing: border-box; background-color: #FAFAFA; font-weight: 400; color: var(--text);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2378909C'%3E%3Cpath d='M2 4l4 4 4-4H2z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: calc(100% - 15px) center;
        }

        input, textarea { 
            width: 100%; padding: 12px; border: 1px solid #ECEFF1; border-radius: 10px; 
            font-size: 0.95rem; box-sizing: border-box; background-color: #FAFAFA; 
            margin-bottom: 5px; font-weight: 400; color: var(--text);
        }

        .book-card { border-bottom: 2px dashed #ECEFF1; margin-bottom: 25px; padding-bottom: 10px; }
        button.main-btn { 
            width: 100%; padding: 14px; background-color: var(--primary); color: white; 
            border: none; border-radius: 12px; font-size: 1rem; font-weight: 400; cursor: pointer; margin-top: 10px; 
        }
        
        /* ç®¡ç†é é¢æ¨™ç±¤æ¨£å¼ */
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        .tag { background: #ECEFF1; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; color: var(--text); }
        .tag span { margin-left: 8px; cursor: pointer; color: #EF5350; font-weight: bold; }

        /* åˆ†äº«é è¦½åœ– */
        #cardPreview { width: 100%; border-radius: 15px; border: 1px solid #ECEFF1; margin-top: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* é€šç”¨èˆ‡å±€éƒ¨è¼‰å…¥å‹•ç•« */
        #loading-text, .local-loader { display: none; text-align: center; color: var(--secondary); font-size: 0.8rem; margin-top: 10px; font-weight: 400; }
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(0,0,0,0.1); border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h2>Eri's Reading Hub ğŸ“–</h2>

    <div class="nav-tabs">
        <button id="tab-add" class="active" onclick="switchTab('add')">æ–°å¢æ›¸ç±</button>
        <button id="tab-update" onclick="switchTab('update')">è£œè¨˜å¿ƒå¾—</button>
        <button id="tab-stats" onclick="switchTab('stats')">é–±è®€çµ±è¨ˆ</button>
        <button id="tab-share" onclick="switchTab('share')">åˆ†äº«å¡ç‰‡</button>
        <button id="tab-manage" onclick="switchTab('manage')">åˆ†é¡ç®¡ç†</button>
    </div>

    <div id="page-add">
        <div id="book-list-container">
            <div class="book-card">
                <div class="form-group"><label>æ›¸å</label><input type="text" class="field-title" placeholder="ä¸­æ–‡æ›¸å"></div>
                <div class="form-group"><label>åˆ†é¡</label><select class="field-category" id="add-category-select"></select></div>
                <div class="form-group"><label>é–±è®€ç‹€æ…‹</label><select class="field-status">
                    <option value="é–±è®€å®Œç•¢â˜‘ï¸">é–±è®€å®Œç•¢â˜‘ï¸</option>
                    <option value="æ­£åœ¨è®€ğŸ“–">æ­£åœ¨è®€ğŸ“–</option>
                    <option value="é¡˜æœ›æ¸…å–®ğŸ§š">é¡˜æœ›æ¸…å–®ğŸ§š</option>
                </select></div>
                <div class="form-group"><label>å¿ƒå¾— (é¸å¡«)</label><textarea class="field-review" rows="2" placeholder="åˆæ­¥æƒ³æ³•..."></textarea></div>
            </div>
        </div>
        <button type="button" id="submitBtn" class="main-btn">ç¢ºèªå„²å­˜è‡³ Notion</button>
    </div>

    <div id="page-update" style="display: none;">
        <div class="form-group"><label>1. é¸æ“‡æ›¸ç±</label><select id="update-select-book"></select></div>
        <div class="form-group"><label>2. è£œè¨˜å¿ƒå¾—</label><textarea id="update-review" rows="5" placeholder="è¼¸å…¥è©³ç´°å¿ƒå¾—..."></textarea></div>
        <button type="button" onclick="submitUpdateReview()" class="main-btn" style="background-color: var(--accent);">æ›´æ–°ç´€éŒ„</button>
    </div>

    <div id="page-stats" style="display: none; padding-bottom: 30px;">
        <div class="form-group">
            <label>ç¯©é¸çµ±è¨ˆæœˆä»½</label>
            <input type="month" id="stats-month-picker" onchange="loadStats()">
        </div>
        <div id="stats-loader" class="local-loader" style="padding: 50px 0;">
            <span class="spinner"></span><p>æ­£åœ¨è¨ˆç®—çµ±è¨ˆæ•¸æ“š...</p>
        </div>
        <div id="stats-content">
            <div style="display: flex; justify-content: space-around; margin-bottom: 20px; text-align: center;">
                <div><p style="font-size: 0.7rem; color: var(--secondary);">é¸å®šæœˆé–±è®€</p><h2 id="stat-month">0</h2></div>
                <div><p style="font-size: 0.7rem; color: var(--secondary);">å¹´åº¦ç´¯è¨ˆ</p><h2 id="stat-year">0</h2></div>
            </div>
            <div style="height: 220px;"><canvas id="categoryChart"></canvas></div>
        </div>
    </div>

    <div id="page-share" style="display: none;">
        <label>é¸æ“‡è¦åˆ†äº«çš„æ›¸</label>
        <select id="share-select-book" onchange="drawShareCard()"></select>
        <canvas id="shareCanvas" width="1080" height="1920" style="display:none;"></canvas>
        <img id="cardPreview" alt="ç”Ÿæˆçš„å¡ç‰‡">
        <button class="main-btn" onclick="shareToSystem()" style="background: var(--accent);">ğŸ“² ç›´æ¥åˆ†äº«è‡³ IG é™å‹•</button>
    </div>

    <div id="page-manage" style="display: none;">
        <label>ç¾æœ‰åˆ†é¡ (é»æ“Š Ã— åˆªé™¤)</label>
        <div id="tag-list" class="tag-container"></div>
        <div class="flex-row">
            <input type="text" id="new-tag-input" placeholder="æ–°åˆ†é¡åç¨±">
            <button onclick="addNewTag()" style="padding:0 15px; border-radius:10px; border:none; background:var(--primary); color:white;">+</button>
        </div>
        <button class="main-btn" onclick="syncCategoriesToNotion()">ğŸ”„ åŒæ­¥è¨­å®šè‡³ Notion</button>
    </div>

    <div id="loading-text"><span class="spinner"></span>è™•ç†ä¸­...</div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxhIlp1aGQGL54ajj3lwDQx9CjYCVrSJ1iYenB42ngJybf9g0hvivjAu8CeyEohkwAJDg/exec";
    let categoryChart, bookList = [], currentCategories = ["è‡ªæˆ‘æˆé•·", "å¿ƒç†å­¸", "æ–‡å­¸å°èªª", "å•†æ¥­ç†è²¡"];

    // åˆå§‹åŒ–æœˆä»½
    document.getElementById('stats-month-picker').value = new Date().toISOString().slice(0, 7);

    function switchTab(tab) {
        ['add', 'update', 'stats', 'share', 'manage'].forEach(t => {
            document.getElementById(`page-${t}`).style.display = t === tab ? 'block' : 'none';
            document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
        });
        if(tab === 'manage') renderTags();
        if(tab === 'share' || tab === 'update') fetchBooksForSelect();
        if(tab === 'stats') loadStats();
        if(tab === 'add') updateAddPageSelect();
    }

    // --- åˆ†é¡ç®¡ç† ---
    function renderTags() {
        document.getElementById('tag-list').innerHTML = currentCategories.map((c, i) => `<div class="tag">${c}<span onclick="removeTag(${i})">Ã—</span></div>`).join('');
    }
    function addNewTag() {
        const input = document.getElementById('new-tag-input');
        if(input.value) { currentCategories.push(input.value); input.value = ''; renderTags(); }
    }
    function removeTag(i) { currentCategories.splice(i, 1); renderTags(); }
    function updateAddPageSelect() {
        document.getElementById('add-category-select').innerHTML = currentCategories.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    async function syncCategoriesToNotion() {
        document.getElementById('loading-text').style.display = 'block';
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'sync_categories', data: currentCategories }) });
            const result = await res.json();
            alert(result.success ? 'âœ… Notion åˆ†é¡åŒæ­¥æˆåŠŸï¼' : 'âŒ åŒæ­¥å¤±æ•—');
        } catch(e) { alert('åŒæ­¥å‡ºéŒ¯'); }
        document.getElementById('loading-text').style.display = 'none';
    }

    // --- æ›¸ç±æ¸…å–®ç²å– ---
    async function fetchBooksForSelect() {
        try {
            const res = await fetch(GAS_URL + "?action=get_book_list");
            const result = await res.json();
            bookList = result.data;
            const options = bookList.map(b => `<option value="${b.id}">${b.title}</option>`).join('');
            document.getElementById('share-select-book').innerHTML = options;
            document.getElementById('update-select-book').innerHTML = options;
            if(bookList.length > 0) drawShareCard();
        } catch(e) { console.error("æŠ“å–æ›¸ç±å¤±æ•—"); }
    }

    // --- çµ±è¨ˆé‚è¼¯ (å„ªåŒ–è™•ç†ä¸­ä½ç½®) ---
    async function loadStats() {
        const targetMonth = document.getElementById('stats-month-picker').value;
        const loader = document.getElementById('stats-loader');
        const content = document.getElementById('stats-content');
        
        loader.style.display = 'block';
        content.style.display = 'none';

        try {
            const res = await fetch(`${GAS_URL}?action=get_stats_raw&month=${targetMonth}`);
            const result = await res.json();
            const stats = result.data;

            document.getElementById('stat-month').innerText = stats.summary.thisMonth;
            document.getElementById('stat-year').innerText = stats.summary.thisYear;

            const ctx = document.getElementById('categoryChart').getContext('2d');
            if(categoryChart) categoryChart.destroy();
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.categoryDist),
                    datasets: [{ data: Object.values(stats.categoryDist), backgroundColor: ['#81C784', '#4DD0E1', '#FFD54F', '#BA68C8', '#E57373'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });
            content.style.display = 'block';
        } catch (e) { alert('çµ±è¨ˆè¼‰å…¥å¤±æ•—'); }
        finally { loader.style.display = 'none'; }
    }

    // --- IG åˆ†äº«å¡ Canvas ---
    function drawShareCard() {
        const canvas = document.getElementById('shareCanvas');
        const ctx = canvas.getContext('2d');
        const bookId = document.getElementById('share-select-book').value;
        const book = bookList.find(b => b.id === bookId);

        ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, 1080, 1920);
        ctx.fillStyle = "#455A64"; ctx.fillRect(0, 0, 1080, 450);
        ctx.fillStyle = "#FFFFFF"; ctx.font = "bold 55px sans-serif"; ctx.fillText("ERI'S READING LOG", 100, 230);
        ctx.fillStyle = "#37474F"; ctx.font = "bold 95px sans-serif"; ctx.fillText(book?.title || "æœªé¸æ›¸ç±", 100, 620);
        ctx.font = "45px sans-serif"; ctx.fillStyle = "#78909C"; ctx.fillText("Author: " + (book?.author || "æœªçŸ¥"), 100, 720);
        ctx.fillStyle = "#F5F7F8"; ctx.fillRect(100, 850, 880, 400);
        ctx.fillStyle = "#455A64"; ctx.font = "italic 40px sans-serif";
        const summary = (book?.review || "é€™æ˜¯ä¸€æœ¬å€¼å¾—æ·±åº¦æ€è€ƒçš„å¥½æ›¸ã€‚").substring(0, 80) + "...";
        ctx.fillText(summary, 130, 950, 820);
        document.getElementById('cardPreview').src = canvas.toDataURL("image/png");
    }

    async function shareToSystem() {
        const canvas = document.getElementById('shareCanvas');
        canvas.toBlob(async (blob) => {
            const file = new File([blob], "reading-note.png", { type: "image/png" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: 'æˆ‘çš„é–±è®€ç­†è¨˜' });
            } else { alert('æ‚¨çš„è£ç½®ä¸æ”¯æ´ç›´æ¥åˆ†äº«ï¼Œè«‹é•·æŒ‰åœ–ç‰‡å„²å­˜å¾Œä¸Šå‚³ã€‚'); }
        });
    }

    // --- æ‰¹é‡å„²å­˜æ›¸ç± ---
    document.getElementById('submitBtn').onclick = async function() {
        const booksData = [];
        document.querySelectorAll('.book-card').forEach(card => {
            const title = card.querySelector('.field-title').value.trim();
            if (title) {
                booksData.push({
                    title: title, category: card.querySelector('.field-category').value,
                    status: card.querySelector('.field-status').value, review: card.querySelector('.field-review').value,
                    dateStr: new Date().toISOString().slice(0, 7)
                });
            }
        });
        document.getElementById('loading-text').style.display = 'block';
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'liff_submit_bulk', data: booksData }) });
            const result = await res.json();
            alert(result.success ? 'âœ… å„²å­˜æˆåŠŸï¼' : 'âŒ å„²å­˜å¤±æ•—');
            location.reload();
        } catch(e) { alert('å„²å­˜éç¨‹å‡ºéŒ¯'); }
        document.getElementById('loading-text').style.display = 'none';
    };

    // --- è£œè¨˜å¿ƒå¾—å„²å­˜ ---
    async function submitUpdateReview() {
        const payload = {
            action: 'update_review',
            data: {
                pageId: document.getElementById('update-select-book').value,
                rating: "â­â­â­â­â­", // é è¨­çµ¦äºˆ 5 æ˜Ÿï¼Œå¯ä¾éœ€æ±‚èª¿æ•´ UI
                review: document.getElementById('update-review').value
            }
        };
        document.getElementById('loading-text').style.display = 'block';
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            alert(result.success ? 'âœ… å¿ƒå¾—å·²æˆåŠŸæ›´æ–°ï¼' : 'âŒ æ›´æ–°å¤±æ•—');
            location.reload();
        } catch(e) { alert('é€£ç·šå¤±æ•—'); }
        document.getElementById('loading-text').style.display = 'none';
    }

    liff.init({ liffId: "2008731100-q3JK2BPf" });
</script>
</body>
</html>
