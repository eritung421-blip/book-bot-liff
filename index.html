<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eri's Reading Hub ğŸ“–</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { 
            --primary: #455A64; --secondary: #78909C; --accent: #81C784; 
            --bg: #F5F7F8; --white: #FFFFFF; --text: #37474F; 
        }
        body { 
            font-family: -apple-system, "Noto Sans TC", sans-serif; 
            background-color: var(--bg); color: var(--text); 
            margin: 0; padding: 20px; display: flex; justify-content: center; 
        }
        .container { 
            width: 100%; max-width: 450px; background: var(--white); 
            padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            box-sizing: border-box; 
        }
        
        /* æ¨™é¡Œä¿ç•™ç²—é«” */
        h2 { color: var(--primary); font-size: 1.3rem; text-align: center; margin-top: 0; font-weight: 600; letter-spacing: 1px; }

        .nav-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .nav-tabs button { 
            flex: 1; padding: 10px; font-size: 0.85rem; border: none; border-radius: 10px; 
            background-color: #ECEFF1; color: var(--secondary); cursor: pointer; 
            font-weight: 400; /* Regular */
        }
        .nav-tabs button.active { background-color: var(--primary); color: white; font-weight: 600; }

        .form-group { margin-bottom: 15px; }
        
        /* ä¿®æ”¹æ¨™ç±¤ç‚º Regular */
        label { display: block; font-size: 0.85rem; font-weight: 400; margin-bottom: 6px; color: var(--secondary); }
        
        /* åƒ…æ›¸åèˆ‡ä½œè€…ä¸¦æ’ */
        .flex-row { display: flex; gap: 8px; }
        .flex-row input { flex: 1; width: 50%; } /* ç¢ºä¿ä¸€åŠä¸€åŠ */

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ•å‡ç‚º Regular */
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #ECEFF1; border-radius: 10px; 
            font-size: 0.95rem; box-sizing: border-box; background-color: #FAFAFA; 
            margin-bottom: 5px; font-weight: 400; color: var(--text);
        }
        input::placeholder { color: #CFD8DC; }

        .book-card { border-bottom: 2px dashed #ECEFF1; margin-bottom: 25px; padding-bottom: 10px; }
        
        /* æŒ‰éˆ•èª¿æ•´ç‚º Regular */
        button.main-btn { 
            width: 100%; padding: 14px; background-color: var(--primary); color: white; 
            border: none; border-radius: 12px; font-size: 1rem; font-weight: 400; 
            cursor: pointer; margin-top: 10px; 
        }
        #addMoreBtn { 
            background-color: transparent; color: var(--secondary); border: 1px solid var(--secondary);
            padding: 10px; border-radius: 10px; font-size: 0.9rem; margin-bottom: 10px; font-weight: 400;
        }

        #loading-text { display: none; text-align: center; color: var(--secondary); font-size: 0.8rem; margin-top: 10px; font-weight: 400; }
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(0,0,0,0.1); border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h2>Eri's Reading Hub ğŸ“–</h2>

    <div class="nav-tabs">
        <button id="tab-add" class="active" onclick="switchTab('add')">æ–°å¢æ›¸ç±</button>
        <button id="tab-update" onclick="switchTab('update')">è£œè¨˜å¿ƒå¾—</button>
        <button id="tab-stats" onclick="switchTab('stats')">é–±è®€çµ±è¨ˆ</button>
    </div>

    <div id="page-add">
        <div id="book-list-container">
            <div class="book-card">
                <div class="form-group">
                    <label>æ›¸å (ä¸­æ–‡ / åŸæ–‡)</label>
                    <div class="flex-row">
                        <input type="text" class="field-title" placeholder="ä¸­æ–‡æ›¸å">
                        <input type="text" class="field-origin-title" placeholder="åŸæ–‡">
                    </div>
                </div>
                <div class="form-group">
                    <label>ä½œè€… (ä¸­æ–‡ / åŸæ–‡)</label>
                    <div class="flex-row">
                        <input type="text" class="field-author" placeholder="è­¯è€…/ä½œè€…">
                        <input type="text" class="field-origin-author" placeholder="åŸæ–‡ä½œè€…">
                    </div>
                </div>
                <div class="form-group">
                    <label>åˆ†é¡</label>
                    <select class="field-category">
                        <option value="è‡ªæˆ‘æˆé•·">è‡ªæˆ‘æˆé•·</option>
                        <option value="å•†æ¥­ç†è²¡">å•†æ¥­ç†è²¡</option>
                        <option value="æ–‡å­¸å°èªª">æ–‡å­¸å°èªª</option>
                        <option value="å¿ƒç†å­¸">å¿ƒç†å­¸</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é–±è®€ç‹€æ…‹</label>
                    <select class="field-status">
                        <option value="é–±è®€å®Œç•¢â˜‘ï¸">é–±è®€å®Œç•¢â˜‘ï¸</option>
                        <option value="æ­£åœ¨è®€ğŸ“–">æ­£åœ¨è®€ğŸ“–</option>
                        <option value="å·²è³¼å…¥ğŸ›’">å·²è³¼å…¥ğŸ›’</option>
                        <option value="é¡˜æœ›æ¸…å–®ğŸ§š">é¡˜æœ›æ¸…å–®ğŸ§š</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è©•åˆ†</label>
                    <select class="field-rating">
                        <option value="å°šæœªè©•åˆ†">å°šæœªè©•åˆ†</option>
                        <option value="â­â­â­â­â­">5æ˜Ÿ</option>
                        <option value="â­â­â­â­">4æ˜Ÿ</option>
                        <option value="â­â­â­">3æ˜Ÿ</option>
                        <option value="â­â­">2æ˜Ÿ</option>
                        <option value="â­">1æ˜Ÿ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¿ƒå¾— (é¸å¡«)</label>
                    <textarea class="field-review" rows="2" placeholder="å¯«ä¸‹å¿ƒå¾—ğŸµ"></textarea>
                </div>
            </div>
        </div>
        <button type="button" id="addMoreBtn">â•å†åŠ ä¸€æœ¬æ›¸</button>
        <button type="button" id="submitBtn" class="main-btn">ç¢ºèªå„²å­˜è‡³ Notion</button>
    </div>

    <div id="page-update" style="display: none;">
        <div class="form-group">
            <label>1. é¸æ“‡æ›¸ç±</label>
            <select id="update-select-book"></select>
        </div>
        <div class="form-group">
            <label>2. æ›´æ–°è©•åˆ†</label>
            <select id="update-rating">
                <option value="â­â­â­â­â­">5æ˜Ÿ</option>
                <option value="â­â­â­â­">4æ˜Ÿ</option>
                <option value="â­â­â­">3æ˜Ÿ</option>
                <option value="â­â­">2æ˜Ÿ</option>
                <option value="â­">1æ˜Ÿ</option>
            </select>
        </div>
        <div class="form-group">
            <label>3. è£œè¨˜å¿ƒå¾—</label>
            <textarea id="update-review" rows="5" placeholder="è¼¸å…¥è©³ç´°å¿ƒå¾—..."></textarea>
        </div>
        <button type="button" id="updateSubmitBtn" class="main-btn" style="background-color: var(--accent);">æ›´æ–°ç´€éŒ„</button>
    </div>

    <div id="page-stats" style="display: none; text-align: center; padding-top: 20px;">
        <p style="font-weight:400; color:var(--secondary);">æœ¬æœˆå·²è®€</p>
        <h1 id="stat-month" style="font-size:3rem; font-weight:600; color:var(--primary); margin: 5px 0;">-</h1>
        <p style="font-weight:400; color:var(--secondary);">ä»Šå¹´ç´¯è¨ˆï¼š<span id="stat-year" style="color:var(--text);">-</span> æœ¬</p>
        <button onclick="loadStats()" style="background:none; border:none; color:var(--secondary); text-decoration:underline; font-size:0.8rem; margin-top:20px;">åˆ·æ–°æ•¸æ“š</button>
    </div>

    <div id="loading-text"><span class="spinner"></span>è™•ç†ä¸­...</div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwbMYQ2KfkQ2Vf2YYn6hNqiCjJySo_6_Gabf152CRpGhRx0AJBE5f9sfw9fM5jM_XQTiw/exec";

    // é é¢åˆ‡æ›
    function switchTab(tab) {
        const pages = ['page-add', 'page-update', 'page-stats'];
        const tabs = ['tab-add', 'tab-update', 'tab-stats'];
        pages.forEach(p => document.getElementById(p).style.display = 'none');
        tabs.forEach(t => document.getElementById(t).classList.remove('active'));
        
        document.getElementById(`page-${tab}`).style.display = 'block';
        document.getElementById(`tab-${tab}`).classList.add('active');

        if(tab === 'update') loadBookList();
        if(tab === 'stats') loadStats();
    }

    // --- å¾¹åº•ä¿®å¾©ã€Œå†åŠ ä¸€æœ¬æ›¸ã€ ---
    document.getElementById('addMoreBtn').addEventListener('click', function() {
        const container = document.getElementById('book-list-container');
        const cards = container.getElementsByClassName('book-card');
        const lastCard = cards[cards.length - 1];
        const newCard = lastCard.cloneNode(true);
        
        // æ¸…ç©ºæ–°å¡ç‰‡çš„æ‰€æœ‰å€¼
        const inputs = newCard.querySelectorAll('input, textarea');
        inputs.forEach(i => i.value = '');
        const selects = newCard.querySelectorAll('select');
        selects.forEach(s => s.selectedIndex = 0);
        
        container.appendChild(newCard);
    });

document.getElementById('submitBtn').onclick = async function() {
    const submitBtn = this;
    const loadingText = document.getElementById('loading-text');
    const cards = document.querySelectorAll('.book-card');
    const booksData = [];

    // 1. æ”¶é›†è³‡æ–™
    cards.forEach(card => {
        const title = card.querySelector('.field-title').value.trim();
        if (title) {
            booksData.push({
                title: title,
                originTitle: card.querySelector('.field-origin-title').value.trim(),
                author: card.querySelector('.field-author').value.trim(),
                originAuthor: card.querySelector('.field-origin-author').value.trim(),
                category: card.querySelector('.field-category').value,
                status: card.querySelector('.field-status').value,
                rating: card.querySelector('.field-rating').value,
                review: card.querySelector('.field-review').value.trim(),
                dateStr: new Date().toISOString().slice(0, 7) // æ ¼å¼: YYYY-MM
            });
        }
    });

    if (booksData.length === 0) return alert('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹æ›¸åï¼');

    // 2. UI ç‹€æ…‹æ›´æ–° (é˜²æ­¢é‡è¤‡é»æ“Š)
    submitBtn.disabled = true;
    loadingText.style.display = 'block';
    loadingText.innerHTML = '<span class="spinner"></span> æ­£åœ¨é€é AI ç”¢ç”Ÿæ‘˜è¦èˆ‡å„²å­˜...';

    try {
        // 3. ç™¼é€è«‹æ±‚ (ç§»é™¤ no-cors)
        const response = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'liff_submit_bulk',
                data: booksData
            })
        });

        const result = await response.json();

        // 4. è™•ç†å›å‚³çµæœ
        if (result.success) {
            const d = result.data;
            let report = `âœ… å„²å­˜å®Œæˆï¼\næˆåŠŸï¼š${d.successCount} æœ¬\nå¤±æ•—ï¼š${d.failCount} æœ¬\n\n`;
            
            d.details.forEach(item => {
                report += `${item.status} ${item.title} ${item.error ? '(' + item.error + ')' : ''}\n`;
            });

            alert(report);
            
            if (d.failCount === 0) {
                location.reload(); // å…¨æ•¸æˆåŠŸæ‰é‡æ–°æ•´ç†
            }
        } else {
            throw new Error(result.error || 'ä¼ºæœå™¨å›å‚³ç•°å¸¸');
        }

    } catch (e) {
        console.error("æäº¤å¤±æ•—", e);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS è¨­å®šï¼š\n' + e.message);
    } finally {
        submitBtn.disabled = false;
        loadingText.style.display = 'none';
    }
};

    // è¼‰å…¥è£œç´€éŒ„åå–®
    async function loadBookList() {
        const select = document.getElementById('update-select-book');
        select.innerHTML = '<option>è¼‰å…¥ä¸­...</option>';
        try {
            const res = await fetch(GAS_URL + "?action=get_book_list");
            const result = await res.json();
            select.innerHTML = result.data.map(b => `<option value="${b.id}">${b.title}</option>`).join('');
        } catch(e) { select.innerHTML = '<option>ç›®å‰ç„¡æ›¸ç±</option>'; }
    }

    // æ›´æ–°å¿ƒå¾—æäº¤
    document.getElementById('updateSubmitBtn').onclick = async function() {
        const payload = {
            action: 'update_review',
            data: {
                pageId: document.getElementById('update-select-book').value,
                rating: document.getElementById('update-rating').value,
                review: document.getElementById('update-review').value
            }
        };
        document.getElementById('loading-text').style.display = 'block';
        await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert('æ›´æ–°æˆåŠŸï¼');
        location.reload();
    };

    // çµ±è¨ˆæ•¸æ“šè¼‰å…¥ (æ›´æ–°ç‰ˆ)
async function loadStats() {
    const monthEl = document.getElementById('stat-month');
    const yearEl = document.getElementById('stat-year');
    const loadingText = document.getElementById('loading-text');

    try {
        monthEl.innerText = '...';
        yearEl.innerText = '...';
        
        // 1. ç™¼é€è«‹æ±‚ (ç§»é™¤ no-cors æ‰èƒ½è®€å–å›å‚³å€¼)
        const res = await fetch(`${GAS_URL}?action=get_stats_raw`);
        const result = await res.json();

        if (result.success) {
            const stats = result.data;
            
            // 2. æ›´æ–°æ•¸å­—æ‘˜è¦ 
            monthEl.innerText = stats.summary.thisMonth;
            yearEl.innerText = stats.summary.thisYear;

            // 3. (é€²éš) å¦‚æœä½ æƒ³é¡¯ç¤ºåˆ†é¡åˆ†ä½ˆï¼Œå¯ä»¥åœ¨é€™è£¡æ“´å…… UI
            console.log("åˆ†é¡åˆ†ä½ˆæ•¸æ“š:", stats.categoryDist);
            renderCategoryStats(stats.categoryDist);
        } else {
            alert('æ•¸æ“šè®€å–å¤±æ•—ï¼š' + result.error);
        }
    } catch (e) {
        console.error("çµ±è¨ˆè¼‰å…¥å¤±æ•—", e);
        alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS æ˜¯å¦å·²æ­£ç¢ºç™¼å¸ƒ');
    } finally {
        loadingText.style.display = 'none';
    }
}

// è¼”åŠ©å‡½å¼ï¼šå‹•æ…‹ç”Ÿæˆåˆ†é¡çµ±è¨ˆæ¸…å–®
function renderCategoryStats(dist) {
    // å‡è¨­ä½ åœ¨ HTML ä¸­æœ‰ä¸€å€‹ id="category-list" çš„å®¹å™¨
    const container = document.getElementById('page-stats');
    let html = '<div style="margin-top:20px; text-align:left; font-size:0.85rem;">';
    html += '<p style="font-weight:bold; color:var(--secondary);">ğŸ“š åˆ†é¡ä½”æ¯”</p>';
    
    for (const [cat, count] of Object.entries(dist)) {
        html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>${cat}</span>
                    <span style="font-weight:600;">${count} æœ¬</span>
                 </div>`;
    }
    html += '</div>';
    
    // ç§»é™¤èˆŠçš„çµ±è¨ˆåˆ—è¡¨(è‹¥æœ‰)ï¼Œå†åŠ å…¥æ–°çš„
    const oldList = document.getElementById('dynamic-cat-list');
    if (oldList) oldList.remove();
    
    const div = document.createElement('div');
    div.id = 'dynamic-cat-list';
    div.innerHTML = html;
    container.appendChild(div);
}
    liff.init({ liffId: "2008731100-q3JK2BPf" });
</script>

</body>
</html>
