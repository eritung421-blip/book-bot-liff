<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eri's Reading Hub ğŸ“–</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { 
            --primary: #455A64; --secondary: #78909C; --accent: #81C784; 
            --bg: #F5F7F8; --white: #FFFFFF; --text: #37474F; 
        }
        body { 
            font-family: -apple-system, "Noto Sans TC", sans-serif; 
            background-color: var(--bg); color: var(--text); 
            margin: 0; padding: 20px; display: flex; justify-content: center; 
        }
        .container { 
            width: 100%; max-width: 450px; background: var(--white); 
            padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            box-sizing: border-box; 
        }
        h2 { color: var(--primary); font-size: 1.3rem; text-align: center; margin-top: 0; font-weight: 600; letter-spacing: 1px; }
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .nav-tabs button { 
            flex: 1; padding: 10px; font-size: 0.85rem; border: none; border-radius: 10px; 
            background-color: #ECEFF1; color: var(--secondary); cursor: pointer; font-weight: 400;
        }
        .nav-tabs button.active { background-color: var(--primary); color: white; font-weight: 600; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 400; margin-bottom: 6px; color: var(--secondary); }
        .flex-row { display: flex; gap: 8px; }
        .flex-row input { flex: 1; width: 50%; }
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #ECEFF1; border-radius: 10px; 
            font-size: 0.95rem; box-sizing: border-box; background-color: #FAFAFA; 
            margin-bottom: 5px; font-weight: 400; color: var(--text);
        }
        .book-card { border-bottom: 2px dashed #ECEFF1; margin-bottom: 25px; padding-bottom: 10px; }
        button.main-btn { 
            width: 100%; padding: 14px; background-color: var(--primary); color: white; 
            border: none; border-radius: 12px; font-size: 1rem; font-weight: 400; cursor: pointer; margin-top: 10px; 
        }
        #addMoreBtn { 
            background-color: transparent; color: var(--secondary); border: 1px solid var(--secondary);
            padding: 10px; border-radius: 10px; font-size: 0.9rem; margin-bottom: 10px; font-weight: 400; width: 100%;
        }
        #loading-text { display: none; text-align: center; color: var(--secondary); font-size: 0.8rem; margin-top: 10px; font-weight: 400; }
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(0,0,0,0.1); border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h2>Eri's Reading Hub ğŸ“–</h2>

    <div class="nav-tabs">
        <button id="tab-add" class="active" onclick="switchTab('add')">æ–°å¢æ›¸ç±</button>
        <button id="tab-update" onclick="switchTab('update')">è£œè¨˜å¿ƒå¾—</button>
        <button id="tab-stats" onclick="switchTab('stats')">é–±è®€çµ±è¨ˆ</button>
    </div>

    <div id="page-add">
        <div id="book-list-container">
            <div class="book-card">
                <div class="form-group">
                    <label>æ›¸å (ä¸­æ–‡ / åŸæ–‡)</label>
                    <div class="flex-row">
                        <input type="text" class="field-title" placeholder="ä¸­æ–‡æ›¸å">
                        <input type="text" class="field-origin-title" placeholder="åŸæ–‡">
                    </div>
                </div>
                <div class="form-group">
                    <label>ä½œè€… (ä¸­æ–‡ / åŸæ–‡)</label>
                    <div class="flex-row">
                        <input type="text" class="field-author" placeholder="è­¯è€…/ä½œè€…">
                        <input type="text" class="field-origin-author" placeholder="åŸæ–‡ä½œè€…">
                    </div>
                </div>
                <div class="form-group">
                    <label>åˆ†é¡</label>
                    <select class="field-category">
                        <option value="è‡ªæˆ‘æˆé•·">è‡ªæˆ‘æˆé•·</option>
                        <option value="å•†æ¥­ç†è²¡">å•†æ¥­ç†è²¡</option>
                        <option value="æ–‡å­¸å°èªª">æ–‡å­¸å°èªª</option>
                        <option value="å¿ƒç†å­¸">å¿ƒç†å­¸</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é–±è®€ç‹€æ…‹</label>
                    <select class="field-status">
                        <option value="é–±è®€å®Œç•¢â˜‘ï¸">é–±è®€å®Œç•¢â˜‘ï¸</option>
                        <option value="æ­£åœ¨è®€ğŸ“–">æ­£åœ¨è®€ğŸ“–</option>
                        <option value="å·²è³¼å…¥ğŸ›’">å·²è³¼å…¥ğŸ›’</option>
                        <option value="é¡˜æœ›æ¸…å–®ğŸ§š">é¡˜æœ›æ¸…å–®ğŸ§š</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è©•åˆ†</label>
                    <select class="field-rating">
                        <option value="å°šæœªè©•åˆ†">å°šæœªè©•åˆ†</option>
                        <option value="â­â­â­â­â­">5æ˜Ÿ</option>
                        <option value="â­â­â­â­">4æ˜Ÿ</option>
                        <option value="â­â­â­">3æ˜Ÿ</option>
                        <option value="â­â­">2æ˜Ÿ</option>
                        <option value="â­">1æ˜Ÿ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¿ƒå¾— (é¸å¡«)</label>
                    <textarea class="field-review" rows="2" placeholder="å¯«ä¸‹å¿ƒå¾—ğŸµ"></textarea>
                </div>
            </div>
        </div>
        <button type="button" id="addMoreBtn">â•å†åŠ ä¸€æœ¬æ›¸</button>
        <button type="button" id="submitBtn" class="main-btn">ç¢ºèªå„²å­˜è‡³ Notion</button>
    </div>

    <div id="page-update" style="display: none;">
        <div class="form-group">
            <label>1. é¸æ“‡æ›¸ç±</label>
            <select id="update-select-book"></select>
        </div>
        <div class="form-group">
            <label>2. æ›´æ–°è©•åˆ†</label>
            <select id="update-rating">
                <option value="â­â­â­â­â­">5æ˜Ÿ</option>
                <option value="â­â­â­â­">4æ˜Ÿ</option>
                <option value="â­â­â­">3æ˜Ÿ</option>
                <option value="â­â­">2æ˜Ÿ</option>
                <option value="â­">1æ˜Ÿ</option>
            </select>
        </div>
        <div class="form-group">
            <label>3. è£œè¨˜å¿ƒå¾—</label>
            <textarea id="update-review" rows="5" placeholder="è¼¸å…¥è©³ç´°å¿ƒå¾—..."></textarea>
        </div>
        <button type="button" id="updateSubmitBtn" class="main-btn" style="background-color: var(--accent);">æ›´æ–°ç´€éŒ„</button>
    </div>

    <div id="page-stats" style="display: none; padding-bottom: 30px;">
        <div style="display: flex; justify-content: space-around; margin-bottom: 20px; text-align: center;">
            <div>
                <p style="font-size: 0.8rem; color: var(--secondary); margin-bottom: 5px;">æœ¬æœˆé–±è®€</p>
                <h2 id="stat-month" style="margin: 0; color: var(--primary);">0</h2>
            </div>
            <div>
                <p style="font-size: 0.8rem; color: var(--secondary); margin-bottom: 5px;">å¹´åº¦ç´¯è¨ˆ</p>
                <h2 id="stat-year" style="margin: 0; color: var(--primary);">0</h2>
            </div>
        </div>
        <label style="display:block; text-align: center; margin-bottom: 10px; font-size: 0.85rem;">ğŸ“ˆ é–±è®€è¶¨å‹¢ (è¿‘åŠå¹´)</label>
        <div style="height: 200px; margin-bottom: 25px;"><canvas id="trendChart"></canvas></div>
        <label style="display:block; text-align: center; margin-bottom: 10px; font-size: 0.85rem;">ğŸ¨ åˆ†é¡åˆ†ä½ˆ</label>
        <div style="height: 200px;"><canvas id="categoryChart"></canvas></div>
        <button onclick="loadStats()" class="main-btn" style="background:none; border:1px solid var(--secondary); color:var(--secondary); font-size:0.8rem; margin-top:20px;">åˆ·æ–°çµ±è¨ˆæ•¸æ“š</button>
    </div>

    <div id="loading-text"><span class="spinner"></span>è™•ç†ä¸­...</div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxTN9oBS7S9YCDYGFi502ZxRFmDDXAaaZJQFCkfWI7GDxVo5dmXPhpSy-aiDmW1qgH6Uw/exec";
    let trendChart, categoryChart;

    function switchTab(tab) {
        document.getElementById('page-add').style.display = tab === 'add' ? 'block' : 'none';
        document.getElementById('page-update').style.display = tab === 'update' ? 'block' : 'none';
        document.getElementById('page-stats').style.display = tab === 'stats' ? 'block' : 'none';
        
        document.getElementById('tab-add').classList.toggle('active', tab === 'add');
        document.getElementById('tab-update').classList.toggle('active', tab === 'update');
        document.getElementById('tab-stats').classList.toggle('active', tab === 'stats');

        if(tab === 'update') loadBookList();
        if(tab === 'stats') loadStats();
    }

    document.getElementById('addMoreBtn').addEventListener('click', function() {
        const container = document.getElementById('book-list-container');
        const cards = container.getElementsByClassName('book-card');
        const newCard = cards[0].cloneNode(true);
        newCard.querySelectorAll('input, textarea').forEach(i => i.value = '');
        newCard.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        container.appendChild(newCard);
    });

    // 1. æ‰¹é‡åŒ¯å…¥æ›¸ç±
    document.getElementById('submitBtn').onclick = async function() {
        const btn = this;
        const loadingText = document.getElementById('loading-text');
        const booksData = [];

        document.querySelectorAll('.book-card').forEach(card => {
            const title = card.querySelector('.field-title').value.trim();
            if (title) {
                booksData.push({
                    title: title,
                    originTitle: card.querySelector('.field-origin-title').value.trim(),
                    author: card.querySelector('.field-author').value.trim(),
                    originAuthor: card.querySelector('.field-origin-author').value.trim(),
                    category: card.querySelector('.field-category').value,
                    status: card.querySelector('.field-status').value,
                    rating: card.querySelector('.field-rating').value,
                    review: card.querySelector('.field-review').value.trim(),
                    dateStr: new Date().toISOString().slice(0, 7)
                });
            }
        });

        if (booksData.length === 0) return alert('è«‹å¡«å¯«æ›¸åï¼');
        btn.disabled = true;
        loadingText.style.display = 'block';

        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'liff_submit_bulk', data: booksData })
            });
            const result = await response.json();
            if (result.success) {
                const d = result.data;
                let report = `âœ… å„²å­˜å®Œæˆï¼\næˆåŠŸï¼š${d.successCount} æœ¬\nå¤±æ•—ï¼š${d.failCount} æœ¬\n`;
                d.details.forEach(item => { report += `\n${item.status} ${item.title} ${item.error || ''}`; });
                alert(report);
                if (d.failCount === 0) location.reload();
            } else { throw new Error(result.error); }
        } catch (e) { alert('å„²å­˜å¤±æ•—ï¼š' + e.message); }
        finally { btn.disabled = false; loadingText.style.display = 'none'; }
    };

    // 2. è¼‰å…¥æ›¸ç±é¸å–®
    async function loadBookList() {
        const select = document.getElementById('update-select-book');
        select.innerHTML = '<option>è¼‰å…¥ä¸­...</option>';
        try {
            const res = await fetch(GAS_URL + "?action=get_book_list");
            const result = await res.json();
            select.innerHTML = result.data.map(b => `<option value="${b.id}">${b.title}</option>`).join('');
        } catch(e) { select.innerHTML = '<option>ç›®å‰ç„¡æ›¸ç±</option>'; }
    }

    // 3. æ›´æ–°å¿ƒå¾— (ç§»é™¤ no-cors ä»¥æª¢æŸ¥å›å‚³)
    document.getElementById('updateSubmitBtn').onclick = async function() {
        const btn = this;
        const loadingText = document.getElementById('loading-text');
        const payload = {
            action: 'update_review',
            data: {
                pageId: document.getElementById('update-select-book').value,
                rating: document.getElementById('update-rating').value,
                review: document.getElementById('update-review').value
            }
        };

        btn.disabled = true;
        loadingText.style.display = 'block';

        try {
            const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await response.json();
            if (result.success) { alert('æ›´æ–°æˆåŠŸï¼'); location.reload(); }
            else { alert('æ›´æ–°å¤±æ•—ï¼š' + result.error); }
        } catch(e) { alert('é€£ç·šå¤±æ•—ï¼š' + e.message); }
        finally { btn.disabled = false; loadingText.style.display = 'none'; }
    };

    // 4. çµ±è¨ˆåœ–è¡¨é‚è¼¯
    async function loadStats() {
        const loadingText = document.getElementById('loading-text');
        loadingText.style.display = 'block';
        try {
            const res = await fetch(`${GAS_URL}?action=get_stats_raw`);
            const result = await res.json();
            const stats = result.data;

            document.getElementById('stat-month').innerText = stats.summary.thisMonth;
            document.getElementById('stat-year').innerText = stats.summary.thisYear;

            const trendCtx = document.getElementById('trendChart').getContext('2d');
            if(trendChart) trendChart.destroy();
            trendChart = new Chart(trendCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.trend),
                    datasets: [{ label: 'å†Šæ•¸', data: Object.values(stats.trend), backgroundColor: '#78909C', borderRadius: 5 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const catCtx = document.getElementById('categoryChart').getContext('2d');
            if(categoryChart) categoryChart.destroy();
            categoryChart = new Chart(catCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.categoryDist),
                    datasets: [{ data: Object.values(stats.categoryDist), backgroundColor: ['#81C784', '#4DD0E1', '#FFD54F', '#BA68C8', '#E57373'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%' }
            });
        } catch (e) { alert('çµ±è¨ˆè¼‰å…¥å¤±æ•—'); }
        finally { loadingText.style.display = 'none'; }
    }

    liff.init({ liffId: "2008731100-q3JK2BPf" });
</script>
</body>
</html>
