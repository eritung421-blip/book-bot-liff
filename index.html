function doPost(e) {
  if (!e || !e.postData) return ContentService.createTextOutput('No Data');
  
  const contents = JSON.parse(e.postData.contents);
  
  // ğŸ”¥ æ–°å¢ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºä¾†è‡ª LIFF çš„ JSON è«‹æ±‚
  if (contents.action === "liff_add_book") {
    // å‘¼å«ä½ ç¾æœ‰çš„å­˜æª”èˆ‡ AI é‚è¼¯
    const result = createNotionPage({
      title: contents.title,
      author: contents.author,
      category: contents.category,
      status: contents.status,
      review: contents.review,
      rating: "â­â­â­â­â­", // LIFF ä¹Ÿå¯ä»¥å¢åŠ è©•åˆ†æ¬„ä½
      dateStr: ""
    });

    // å­˜æª”æˆåŠŸå¾Œï¼Œä¸»å‹•ç™¼é€è¨Šæ¯é€šçŸ¥ä½¿ç”¨è€… (éœ€æœ‰ userId)
    if (result.success && contents.userId) {
       pushLineMessage(contents.userId, "ğŸ‰ é€é LIFF æˆåŠŸç´€éŒ„ã€Š" + contents.title + "ã€‹ï¼AI æ‘˜è¦å·²åŒæ­¥è‡³ Notionã€‚");
    }
    
    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  }

  // åŸæœ‰çš„ LINE Bot äº‹ä»¶è™•ç†
  try {
    const body = contents;
    if (!body.events || body.events.length === 0) return ContentService.createTextOutput('OK');
    // ... åŸæœ¬çš„ handleTextMessage é‚è¼¯ ...
  } catch (err) { ... }
}

// è¼”åŠ©å‡½å¼ï¼šä¸»å‹•æ¨æ’­è¨Šæ¯
function pushLineMessage(userId, text) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
    method: 'post',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    payload: JSON.stringify({ to: userId, messages: [{ type: 'text', text: text }] })
  });
}
