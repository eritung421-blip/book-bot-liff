<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™ºèƒ½æ›¸ç±ç´€éŒ„</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --primary: #455A64;   /* æ·±å²©ç° */
            --secondary: #78909C; /* è—ç° */
            --accent: #81C784;    /* è«è˜­è¿ªç¶  */
            --bg: #F5F7F8;
            --white: #FFFFFF;
            --text: #37474F;
        }

        body {
            font-family: -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 20px;
            display: flex; justify-content: center;
        }

        .container {
            width: 100%; max-width: 450px;
            background: var(--white);
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        h2 {
            color: var(--primary); font-size: 1.4rem; text-align: center;
            margin-top: 0; margin-bottom: 25px; letter-spacing: 2px;
        }

        .form-group { margin-bottom: 18px; }

        label {
            display: block; font-size: 0.9rem; font-weight: 600;
            margin-bottom: 8px; color: var(--secondary);
        }

        input, select, textarea {
            width: 100%; padding: 12px;
            border: 1px solid #ECEFF1; border-radius: 10px;
            font-size: 1rem; box-sizing: border-box;
            background-color: #FAFAFA; color: var(--text);
            transition: all 0.3s ease;
            -webkit-appearance: none; /* ç§»é™¤ iOS é è¨­æ¨£å¼ */
        }

        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--secondary);
            background-color: #FFF; box-shadow: 0 0 0 3px rgba(120, 144, 156, 0.1);
        }

        button {
            width: 100%; padding: 15px;
            background-color: var(--primary);
            color: white; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: 600;
            cursor: pointer; transition: 0.3s;
            margin-top: 15px;
        }

        button:active { opacity: 0.8; transform: scale(0.98); }
        button:disabled { background-color: #B0BEC5; cursor: not-allowed; }

        /* æˆåŠŸå‹•ç•«é®ç½© */
        #success-overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--white); z-index: 100;
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }

        .check-icon {
            width: 80px; height: 80px; background: var(--accent);
            color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; margin-bottom: 20px;
            animation: pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        .btn-group { display: flex; gap: 12px; width: 85%; margin-top: 20px; }
        .btn-outline { background: transparent; border: 1.5px solid var(--secondary); color: var(--secondary); }

        #loading-text {
            display: none; text-align: center; color: var(--secondary);
            font-size: 0.85rem; margin-top: 15px;
        }

        /* æ—‹è½‰å‹•ç•« */
        .spinner {
            display: inline-block; width: 12px; height: 12px;
            border: 2px solid rgba(120, 144, 156, 0.2);
            border-top-color: var(--secondary);
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container" id="form-container">
    <h2>ğŸ“– æ™ºèƒ½é–±è®€ç´€éŒ„</h2>
    
    <div id="book-list">
        <div class="book-card" style="border-bottom: 2px dashed #ECEFF1; margin-bottom: 20px; padding-bottom: 10px;">
            <div class="form-group">
                <label>æ›¸å (å¿…å¡«)</label>
                <input type="text" class="field-title" required placeholder="ä¾‹å¦‚ï¼šåŸå­ç¿’æ…£">
            </div>
            <div class="form-group">
                <label>ä½œè€… / é¡åˆ¥</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" class="field-author" placeholder="ä½œè€…" style="flex: 1;">
                    <select class="field-category" style="flex: 1;">
                        <option value="è‡ªæˆ‘æˆé•·">è‡ªæˆ‘æˆé•·</option>
                        <option value="å•†æ¥­ç†è²¡">å•†æ¥­ç†è²¡</option>
                        <option value="å¿ƒç†å­¸">å¿ƒç†å­¸</option>
                        <option value="æ–‡å­¸å°èªª">æ–‡å­¸å°èªª</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>ç‹€æ…‹ / è©•åˆ†</label>
                <div style="display: flex; gap: 10px;">
                    <select class="field-status" style="flex: 1;">
                        <option value="é–±è®€å®Œç•¢â˜‘ï¸" selected>é–±è®€å®Œç•¢â˜‘ï¸</option>
                        <option value="æ­£åœ¨è®€ğŸ“–">æ­£åœ¨è®€ğŸ“–</option>
                        <option value="å·²è³¼å…¥ğŸ›’">å·²è³¼å…¥ğŸ›’</option>
                    </select>
                    <select class="field-rating" style="flex: 1;">
                        <option value="â­â­â­â­â­">5æ˜Ÿ</option>
                        <option value="â­â­â­â­">4æ˜Ÿ</option>
                        <option value="â­â­â­">3æ˜Ÿ</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <button type="button" id="addMoreBtn" style="background-color: var(--secondary); margin-bottom: 10px;">â• å†åŠ ä¸€æœ¬æ›¸</button>
    <button type="button" id="submitBtn">ç¢ºèªå„²å­˜è‡³ Notion</button>
    
    <div id="loading-text"><span class="spinner"></span>AI æ­£åœ¨æ‰¹æ¬¡è™•ç†ä¸­...</div>
</div>

<script>
    // â• é»æ“Šå¢åŠ æ¬„ä½çš„é‚è¼¯
    document.getElementById('addMoreBtn').addEventListener('click', () => {
        const bookList = document.getElementById('book-list');
        const newCard = bookList.children[0].cloneNode(true); // è¤‡è£½ç¬¬ä¸€çµ„
        // æ¸…ç©ºè¤‡è£½å‡ºä¾†çš„æ–‡å­—å…§å®¹
        newCard.querySelectorAll('input').forEach(input => input.value = '');
        bookList.appendChild(newCard);
    });

    // ä¿®æ”¹æäº¤é‚è¼¯ï¼šæ”¶é›†æ‰€æœ‰å¡ç‰‡çš„è³‡æ–™
    document.getElementById('submitBtn').addEventListener('click', async () => {
        const btn = document.getElementById('submitBtn');
        const cards = document.querySelectorAll('.book-card');
        const booksData = [];

        cards.forEach(card => {
            const title = card.querySelector('.field-title').value;
            if (title) {
                booksData.push({
                    title: title,
                    author: card.querySelector('.field-author').value || 'æœªçŸ¥',
                    category: card.querySelector('.field-category').value,
                    status: card.querySelector('.field-status').value,
                    rating: card.querySelector('.field-rating').value,
                    dateStr: new Date().toISOString().slice(0, 7)
                });
            }
        });

        if (booksData.length === 0) return alert('è«‹è‡³å°‘å¡«å¯«ä¸€æœ¬æ›¸å');

        btn.disabled = true;
        document.getElementById('loading-text').style.display = 'block';

        // ç™¼é€é™£åˆ—åˆ° GAS
        await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'liff_submit_bulk', data: booksData })
        });

        setTimeout(() => {
            document.getElementById('success-overlay').style.display = 'flex';
        }, 2000);
    });
</script>

<script>
    // ğŸ”´ é€™è£¡è«‹å¡«å…¥ä½ çš„ GAS éƒ¨ç½²ç¶²å€
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzKHyRGOdmG6ajYqpgS_HQVH45HaD2HEOpHeeRuDlvcMEtexfZyoEriW8YeTQMQ9BFq_w/exec"; 
    const MY_LIFF_ID = "2008731100-q3JK2BPf";

    async function initLiff() {
        try {
            await liff.init({ liffId: MY_LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        } catch (error) {
            console.error('LIFF åˆå§‹åŒ–å¤±æ•—', error);
        }
    }

    document.getElementById('bookForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtn');
        const loadText = document.getElementById('loading-text');
        
        btn.disabled = true;
        loadText.style.display = 'block';

        const payload = {
            action: 'liff_submit',
            data: {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value || 'æœªçŸ¥',
                category: document.getElementById('category').value,
                status: document.getElementById('status').value,
                rating: document.getElementById('rating').value,
                review: document.getElementById('review').value,
                dateStr: new Date().toISOString().slice(0, 7) // æ ¼å¼: YYYY-MM
            }
        };

        try {
            // ä½¿ç”¨ fetch å‚³é€åˆ° GAS
            // æ³¨æ„ï¼šGAS è·¨ç¶²åŸŸè«‹æ±‚é€šå¸¸æœƒå ± CORSï¼Œä½†è³‡æ–™å…¶å¯¦æœƒé€é”
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors', // è§£æ±º GAS CORS é™åˆ¶
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // ç”±æ–¼ AI ç”Ÿæˆéœ€è¦æ™‚é–“ï¼Œæˆ‘å€‘çµ¦äºˆä¸€é»å»¶é²æ„Ÿ
            setTimeout(() => {
                document.getElementById('success-overlay').style.display = 'flex';
                btn.disabled = false;
                loadText.style.display = 'none';
            }, 2000);

        } catch (error) {
            alert('ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹æª¢æŸ¥é€£ç·šæˆ– GAS ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚');
            btn.disabled = false;
            loadText.style.display = 'none';
        }
    });

    initLiff();
</script>

</body>
</html>
